# Enterprise audit – what was broken and what was fixed

## 1) Wallet page had no menu (sidebar/topbar)

- **What was broken:** The Coins/Wallet page (`coins.html`, `coins-ar.html`) used only the public site header (navbar with Home, Browse Projects, Dashboard, Coins). It did not show the dashboard sidebar or user dropdown that other dashboard pages (e.g. `dashboard.html`) use, so navigation was inconsistent and “Wallet page has no menu” was reported.
- **Root cause:** The wallet pages were built as standalone public-style pages and never given the same layout as the dashboard (header + `.dashboard-container` with `.dashboard-sidebar` + `.dashboard-content`).
- **What was changed:**
  - Added `css/dashboard-layout.css` with shared styles for `.dashboard-container`, `.dashboard-sidebar`, `.dashboard-content`, and sidebar menu (used by dashboard and wallet).
  - Updated `coins.html` and `coins-ar.html`: same header as dashboard (with user dropdown and “My Wallet” / “محفظتي” in nav), plus `dashboard-container` > `dashboard-sidebar` (with “My Wallet” active) + `dashboard-content` > existing wallet content.
  - Sidebar shows user name/email from `window.auth.getUser()` and the same nav links as dashboard (Dashboard, My Projects, Backed Projects, Payments, My Wallet, Notifications, Profile, Settings, Help & Support, Logout).
- **How verified:** Manual check that `coins.html` and `coins-ar.html` render the sidebar and user dropdown; Playwright audit crawler checks that `/coins.html` has `.dashboard-sidebar` and records result in `reports/audit.json` / `reports/audit.md`.

---

## 2) Coin image had a white box

- **What was broken:** The coin image on the wallet hero showed a visible white square/box around the coin, making it look non-transparent.
- **Root cause:** Either the asset `images/coin.png` had an opaque white background, or the container/`img` had a background that showed as white.
- **What was changed:**
  - Applied CSS so the coin container and image do not add a background:  
    `.coin-icon-large { background: transparent !important; }`  
    `.coin-icon-large .coin-icon-img { background: transparent !important; }`  
    (in both `coins.html` and `coins-ar.html`.)
  - If the PNG file itself has a white fill, replace `public_html/images/coin.png` with a transparent PNG or WebP (see RENDER_DEPLOYMENT.md / VERIFICATION_CHECKLIST.md).
- **How verified:** Visual check; no white box when the asset is transparent. If the file is still opaque white, replacing the asset is required for a fully clean look.

---

## 3) Buttons / API not working (wrong auth token key)

- **What was broken:** Wallet API calls (balance, buy, send, cash out, history) could fail or “do nothing” because the front end was reading the wrong localStorage key for the auth token.
- **Root cause:** `auth-handler.js` and the rest of the app use `localStorage.getItem('token')` and `window.auth.getToken()`, but `coins.html` and `coins-ar.html` used `localStorage.getItem('authToken')`, so requests were sent without a token (or with the wrong one).
- **What was changed:**
  - In `coins.html` and `coins-ar.html`, token is now:  
    `const token = window.auth ? window.auth.getToken() : localStorage.getItem('token');`
  - Wallet buttons (preset amounts, “Buy with Stripe”, “Send Coins”, “Request Cash Out”) were already wired (onclick / script); they now receive the correct token and can call the API and show loading/error toasts.
- **How verified:** With a logged-in user, wallet balance and actions use the token; audit crawler checks that preset buttons and Buy CTA exist and that preset click sets the amount input.

---

## 4) Automated audit + reports

- **What was added:**
  - **Playwright audit crawler:** `tests/audit-crawler.spec.js` crawls key pages (home, login, signup, projects, dashboard, coins, how-it-works, about, contact), records HTTP status, console errors, failed network requests, and checks for header and (where applicable) sidebar.
  - **Coins page:** Asserts that `/coins.html` has `.dashboard-sidebar` and balance section; checks that preset amount buttons and Buy button exist and that clicking a preset sets the amount.
  - **Viewport:** One viewport check (390×844) to detect horizontal overflow on the home page.
  - **Runner:** `scripts/run-audit-crawler.js` starts the server on a test port, runs the audit spec with `--workers=1`, then reads `reports/audit-raw.json` and generates `reports/audit.json` and `reports/audit.md` (summary, problems list, page checks, button/UX checks).
- **How to run:**  
  `npm run audit`  
  (Requires MongoDB and env e.g. `MONGO_URI` / `MONGODB_URI`, `JWT_SECRET`; script sets defaults for a local test run.)

---

## 5) Deliverables

- **reports/audit.json** and **reports/audit.md:** Generated by `npm run audit` (initial run and after fixes).
- **ENTERPRISE_FIXES.md:** This file (what was broken, root cause, what was changed, how verified).
- **.env.example:** Required env var names only (no secrets); already present and listing MONGODB_URI, JWT_SECRET, BASE_URL, STRIPE_*, etc.
- **RENDER_DEPLOYMENT.md:** Build command (`npm install`), start command (`npm start`), required env vars, MongoDB Atlas notes; already present. Optional alias: **RENDER_DEPLOY.md** can point to it if desired.

---

## 5) Creator / Backer / Admin flows (production-ready)

- **Project model:** Added `coverImage`, `gallery[]`, `videoUrl`, `story`, `rewards`; default `status` = `draft`. Uploads: `POST /api/projects/upload-cover`, `POST /api/projects/upload-gallery` (multer, 8MB, images); stored under `public_html/uploads/projects/`.
- **Create project:** `create-project.html` has auth, form submit (upload cover + gallery then `POST /api/projects`), loading/error states. **Dashboard:** My Projects and Backed Projects load from `/api/projects/user/me` and `/api/coins/backed`; stats from API. **PUT /api/projects/:id** for creator updates.
- **Backer:** `GET /api/coins/backed`; project details show cover/gallery/video and "Back this project" → `coins.html?projectId=...`; coins page pre-selects project from URL. Public list shows only active/completed.
- **Admin:** All `/api/admin/*` use `protect` + `adminOnly` (server-side). Flows audit: `tests/flows-audit.spec.js` + `npm run flows-audit` → `reports/flows-audit.json`, `reports/flows-audit.md`. **PLATFORM_VERIFICATION.md** and **RENDER_DEPLOYMENT.md** (file storage, scans) updated.

---

## Summary

| Issue | Root cause | Fix |
|-------|------------|-----|
| Wallet page has no menu | Wallet pages not using dashboard layout | Added dashboard sidebar + same header to coins.html / coins-ar.html |
| Coin image white box | Background on container/img or opaque PNG | CSS transparent background; replace coin.png if needed |
| Buttons/API “do nothing” | Wrong token key (`authToken` vs `token`) | Use `window.auth.getToken()` / `localStorage.getItem('token')` on wallet pages |
| No automated audit | No crawler + report | Playwright audit spec + run-audit-crawler.js → audit.json / audit.md |
| Creator uploads / dashboard | No project images or API-driven dashboard | Project uploads + create-project submit; dashboard from /api/projects/user/me and /api/coins/backed |
| Backer backed list | No API | GET /api/coins/backed; dashboard Backed tab |
| Flows E2E | None | flows-audit.spec.js + run-flows-audit.js → flows-audit.json / .md |
